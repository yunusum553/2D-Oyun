<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARYA SAVAÅžÃ‡ISI - STABÄ°L + WAV SES</title>
    <style>
        /* CSS KODLARI (AynÄ±) */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            margin: 0;
            background-color: #000;
            overflow: hidden; 
        }

        #gameContainer {
            position: relative;
            width: 700px;
            height: 1000px;
            border: 5px solid #fff;
            box-shadow: 0 0 50px #00ffcc;
            cursor: default; 
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .game-info {
            position: absolute;
            color: #fff;
            font-family: monospace;
            font-size: 24px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 3px;
            z-index: 10;
        }

        #scoreBoard { top: 10px; right: 10px; }
        #levelBoard { top: 50px; right: 10px; color: #ffcc00; }
        #difficultyBoard { top: 90px; right: 10px; color: #ff00ff; font-size: 18px; } 
        
        #healthBarContainer { 
            top: 10px; 
            left: 10px; 
            color: #fff; 
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
        }
        
        #healthBar {
            width: 150px;
            height: 20px;
            background-color: #333;
            border: 2px solid white;
            margin-left: 10px;
        }

        #healthFill {
            height: 100%;
            background-color: #ff0000;
            transition: width 0.2s; 
        }

        #progressContainer {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 20px;
            background-color: rgba(50, 50, 50, 0.8);
            border: 2px solid #00ffcc;
            z-index: 10;
            overflow: hidden;
            border-radius: 5px;
        }
        #progressBar {
            height: 100%;
            width: 0%;
            background-color: #00ffcc;
            transition: width 0.3s;
        }
        
        .full-screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 1);
            color: #fff;
            font-family: monospace;
            font-size: 30px;
            z-index: 30;
            cursor: default !important; 
        }
        
        #difficultyOptions {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        #startScreen .difficulty-button {
            padding: 15px 25px;
            font-size: 22px;
            cursor: pointer;
            background: linear-gradient(145deg, #1f1f1f, #333333);
            color: #00ffcc;
            border: 2px solid #00ffcc;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 255, 204, 0.3);
            transition: all 0.2s ease;
        }
        #startScreen .difficulty-button:hover {
            background: linear-gradient(145deg, #00ffcc, #00cc99);
            color: #000;
            transform: scale(1.05);
        }
        
        #highScoreTable {
            width: 90%; max-width: 500px; margin-top: 40px; border-collapse: collapse;
            font-size: 20px; background: rgba(20, 20, 50, 0.9); border-radius: 10px; overflow: hidden;
        }
        #highScoreTable th, #highScoreTable td {
            padding: 10px 15px; border-bottom: 1px solid #00ffcc; text-align: left;
        }
        #highScoreTable th {
            background-color: #00ffcc; color: #000; font-weight: bold;
        }
        #highScoreTable td:nth-child(2) {
            text-align: right; color: #ffcc00;
        }
        #controlsText {
            margin-top: 20px; font-size: 18px; color: #aaa; text-align: center;
            border: 1px dashed #333; padding: 10px; border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        
        <div id="loginScreen" class="full-screen-overlay">
            <h1>HOÅž GELDÄ°N UZAY SAVAÅžÃ‡ISI!</h1>
            <p>Devam etmek iÃ§in adÄ±nÄ± gir.</p>
            <input type="text" id="playerNameInput" placeholder="KullanÄ±cÄ± AdÄ±" maxlength="10" style="padding: 10px; font-size: 20px; margin: 20px 0; width: 80%; max-width: 300px; border: 2px solid #00ffcc; background: #333; color: #fff; text-align: center;">
            <button id="loginButton" style="padding: 10px 20px; font-size: 20px; cursor: pointer; background-color: #00ffcc; color: #000; border: none; border-radius: 5px;">OYUNA GÄ°RÄ°Åž</button>
            <p id="lastPlayerDisplay" style="font-size: 18px; margin-top: 10px;"></p>
        </div>

        <div id="startScreen" class="full-screen-overlay" style="display: none;">
            <h1>UZAY SAVAÅžI</h1>
            <p>HoÅŸ geldin, <span id="currentUserName">Oyuncu</span>!</p>
            <p>KayÄ±tlÄ± En YÃ¼ksek Seviye: <span id="maxLevelDisplay">1</span></p>
            
            <div id="controlsText">
                Kontroller:<br>
                **HarekÃ¢t:** Fare (Mouse) hareket ettirme<br>
                **AteÅŸ Etme:** Fare Sol TÄ±klama (Mouse Click)<br>
                **Duraklatma/Fare Serbest BÄ±rakma:** ESC
            </div>

            <p style="margin-top: 30px;">Zorluk Seviyesini SeÃ§in:</p>
            <div id="difficultyOptions">
                <button class="difficulty-button" data-difficulty="normal">NORMAL</button>
                <button class="difficulty-button" data-difficulty="hard">ZOR (HARD)</button>
                <button class="difficulty-button" data-difficulty="very_hard">Ã‡OK ZOR</button>
            </div>
            <p style="font-size: 18px; color: #00ffcc; margin-top: 0;">Zorluk seÃ§imi yaptÄ±ktan sonra oyunu baÅŸlatmak iÃ§in **tÄ±klayÄ±n**.</p>
            
            <table id="highScoreTable">
                <thead>
                    <tr>
                        <th>ðŸ¥‡ Ä°sim</th>
                        <th>ðŸ’° YÃ¼ksek Puan</th>
                    </tr>
                </thead>
                <tbody id="highScoreBody">
                    </tbody>
            </table>
        </div>

        <div id="healthBarContainer">
            CAN: 
            <div id="healthBar">
                <div id="healthFill"></div>
            </div>
        </div>
        
        <div id="progressContainer">
            <div id="progressBar"></div>
        </div>
        
        <div id="scoreBoard" class="game-info">Puan: 0</div>
        <div id="levelBoard" class="game-info">Seviye: 1/50 | AteÅŸ Lv: 1</div>
        <div id="difficultyBoard" class="game-info">Zorluk: NORMAL</div> 

        <div id="persistentInfo" class="game-info" style="bottom: 10px; left: 10px; transform: none; background: rgba(0, 0, 0, 0.6); font-size: 16px;">KullanÄ±cÄ±: <span id="savedUserName">Anonim</span> | Max Seviye: <span id="savedLevel">1</span></div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div id="levelCompleteMessage" class="full-screen-overlay" style="display: none; background-color: rgba(0, 100, 0, 0.7); font-size: 40px; z-index: 25;">
            <h2 id="levelCompleteTitle" style="font-size: 70px; color: #ffcc00; margin-bottom: 20px;">BÃ–LÃœM GEÃ‡Ä°LDÄ°!</h2>
            <p id="levelCompleteText">BÃ¶lÃ¼m 2'ye HoÅŸ Geldiniz!</p>
        </div>

        <div id="gameOverScreen" class="full-screen-overlay" style="display: none; font-size: 60px;">
            <p>OYUN BÄ°TTÄ°!</p>
            <p>Son PuanÄ±nÄ±z: <span id="finalScore">0</span></p>
            <p class="restart-text" style="font-size: 30px; color: #ffcc00;">Yeniden baÅŸlamak iÃ§in 'R' tuÅŸuna basÄ±n</p>
            <p style="font-size: 16px; color: #aaa;">(ESC tuÅŸu ile fareyi serbest bÄ±rakÄ±n)</p>
        </div>
    </div>

    <audio id="playerShootSound" src="lazer.wav" preload="auto"></audio> 
    <audio id="enemyExplosionSound" src="patlama.wav" preload="auto"></audio> 
    <audio id="playerDamageSound" src="hasar.wav" preload="auto"></audio> 
    <audio id="backgroundMusic" src="uzay_muzigi.wav" preload="auto" loop></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('gameCanvas');
            canvas.width = 700;
            canvas.height = 1000;

            const ctx = canvas.getContext('2d');
            const gameContainer = document.getElementById('gameContainer'); 
            
            // HTML Elementleri (HUD, Ekranlar vb.)
            const healthFill = document.getElementById('healthFill'); 
            const gameOverScreen = document.getElementById('gameOverScreen');
            const startScreen = document.getElementById('startScreen');
            const difficultyOptions = document.getElementById('difficultyOptions');
            const levelCompleteMessage = document.getElementById('levelCompleteMessage');
            const levelCompleteText = document.getElementById('levelCompleteText');
            const loginScreen = document.getElementById('loginScreen');
            const loginButton = document.getElementById('loginButton');
            const playerNameInput = document.getElementById('playerNameInput');
            const currentUserNameDisplay = document.getElementById('currentUserName');
            const savedUserNameDisplay = document.getElementById('savedUserName');
            const lastPlayerDisplay = document.getElementById('lastPlayerDisplay');
            const highScoreBody = document.getElementById('highScoreBody');
            
            // SES ELEMENTLERÄ°
            const playerShootSound = document.getElementById('playerShootSound');
            const enemyExplosionSound = document.getElementById('enemyExplosionSound');
            const playerDamageSound = document.getElementById('playerDamageSound');
            const backgroundMusic = document.getElementById('backgroundMusic');

            // GÃœNCELLENMÄ°Åž SES YÃ–NETÄ°MÄ° FONKSÄ°YONU
            function playSound(audioElement) {
                // Sesi Ã§almadan Ã¶nce, kaynaÄŸÄ±n yÃ¼klenip yÃ¼klenmediÄŸini kontrol etmek Ã¶nemlidir.
                // readyState >= 3 (HAVE_FUTURE_DATA) veya readyState === 4 (HAVE_ENOUGH_DATA) olmalÄ±dÄ±r.
                if (audioElement && audioElement.readyState >= 3) {
                    const clone = audioElement.cloneNode();
                    clone.volume = 0.5; 
                    clone.play().catch(e => {
                         console.error("Ses Ã§alma baÅŸarÄ±sÄ±z. TarayÄ±cÄ± kÄ±sÄ±tlamasÄ± olabilir.", e);
                    });
                }
            }


            // --- TEMEL SABÄ°TLER ---
            const MAX_LEVELS = 50; 
            const BASE_ENEMY_COUNT = 20; 
            const ENEMY_BULLET_SPEED = 8; 
            const PLAYER_BULLET_SPEED = 18; 
            const playerBulletColor = '#ff0033'; 
            const enemyBulletColor = '#00ff00'; 
            const enemyBaseSize = 35; 
            const powerUpSize = 30;
            
            const DIFFICULTY_SETTINGS = {
                'normal': { healthScale: 0.15, fireRateScale: 0.8, baseFireRate: 150 },
                'hard': { healthScale: 0.25, fireRateScale: 0.7, baseFireRate: 100 },
                'very_hard': { healthScale: 0.40, fireRateScale: 0.5, baseFireRate: 60 }
            };
            
            // --- Oyun DeÄŸiÅŸkenleri ---
            let score = 0;
            let level = 1;
            let currentDifficulty = 'normal';
            let maxSavedLevel = 1; 
            let currentUserName = 'Anonim';
            let enemiesRemainingInLevel = 0;
            
            const player = {
                x: canvas.width / 2, y: canvas.height - 80, width: 50, height: 40, color: '#00ccff',
                health: 150, fireRate: 15, fireCooldown: 0,
                fireLevel: 1, damageCooldown: 0
            };
            
            let playerBullets = [];
            let enemyBullets = [];
            let enemies = [];
            let powerUps = [];
            let explosions = []; 
            
            let gameLoopId;
            let isGameOver = false;
            let isGamePaused = true; 
            let isPointerLocked = false; 
            let isLevelComplete = false; 
            let isMouseDown = false;
            let isGameStarted = false; 
            
            function updateStatus() {
                document.getElementById('scoreBoard').textContent = `Puan: ${score.toLocaleString()}`;
                document.getElementById('levelBoard').textContent = `Seviye: ${level}/${MAX_LEVELS} | AteÅŸ Lv: ${player.fireLevel}`;

                const healthPercentage = (player.health / 150) * 100; 
                healthFill.style.width = `${healthPercentage}%`;
                healthFill.style.backgroundColor = healthPercentage > 50 ? '#00ff00' : (healthPercentage > 20 ? '#ffcc00' : '#ff0000');
                
                const totalEnemies = enemiesRemainingInLevel; 
                const currentEnemies = enemies.length;
                const progressPercentage = totalEnemies > 0 ? ((totalEnemies - currentEnemies) / totalEnemies) * 100 : 100;

                document.getElementById('progressBar').style.width = `${progressPercentage}%`;


                if (player.health <= 0) {
                    isGameOver = true;
                }
            }


            // --- KayÄ±t ve SÄ±ralama YÃ¶netimi (AynÄ±) ---
            
            function loadPlayerData() {
                const savedLevel = localStorage.getItem('maxLevel');
                maxSavedLevel = savedLevel ? parseInt(savedLevel) : 1;
                document.getElementById('savedLevel').textContent = maxSavedLevel;
                document.getElementById('maxLevelDisplay').textContent = maxSavedLevel;
                
                const savedName = localStorage.getItem('userName');
                if (savedName) {
                    currentUserName = savedName;
                    playerNameInput.value = savedName;
                    lastPlayerDisplay.textContent = `Son oyuncu: ${savedName}`;
                } else {
                    lastPlayerDisplay.textContent = `Oturum aÃ§an oyuncu yok.`;
                }
                loadHighScores();
            }

            function saveCurrentLevel() {
                if (level > maxSavedLevel) {
                    maxSavedLevel = level;
                    localStorage.setItem('maxLevel', maxSavedLevel);
                    document.getElementById('savedLevel').textContent = maxSavedLevel;
                    document.getElementById('maxLevelDisplay').textContent = maxSavedLevel;
                }
            }
            
            function saveUserName(name) {
                currentUserName = name;
                localStorage.setItem('userName', name);
                currentUserNameDisplay.textContent = name;
                savedUserNameDisplay.textContent = name;
            }

            function loadHighScores() {
                const scores = JSON.parse(localStorage.getItem('highScores') || '[]');
                scores.sort((a, b) => b.score - a.score);
                
                highScoreBody.innerHTML = '';
                scores.slice(0, 5).forEach(item => {
                    const row = highScoreBody.insertRow();
                    row.insertCell(0).textContent = item.name;
                    row.insertCell(1).textContent = item.score.toLocaleString();
                });
            }

            function saveHighScore(name, newScore) {
                let scores = JSON.parse(localStorage.getItem('highScores') || '[]');
                
                const existingIndex = scores.findIndex(s => s.name === name);
                
                if (existingIndex > -1) {
                    if (newScore > scores[existingIndex].score) {
                        scores[existingIndex].score = newScore;
                    }
                } else {
                    scores.push({ name: name, score: newScore });
                }
                
                localStorage.setItem('highScores', JSON.stringify(scores));
                loadHighScores(); 
            }

            // --- GÃ–RSEL FONKSÄ°YONLAR (AynÄ±) ---
            
            function addExplosion(x, y, color = '#ff9900') {
                for (let i = 0; i < 10; i++) {
                    explosions.push({
                        x: x, y: y, radius: Math.random() * 5 + 2, color: color,
                        velocity: { x: (Math.random() - 0.5) * 4, y: (Math.random() - 0.5) * 4 },
                        lifetime: 30 
                    });
                }
            }

            function drawExplosions() {
                for (let i = 0; i < explosions.length; i++) {
                    const exp = explosions[i];
                    exp.x += exp.velocity.x;
                    exp.y += exp.velocity.y;
                    exp.lifetime--;
                    
                    ctx.fillStyle = exp.color;
                    ctx.globalAlpha = exp.lifetime / 30; 
                    ctx.beginPath();
                    ctx.arc(exp.x, exp.y, exp.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    if (exp.lifetime <= 0) {
                        explosions.splice(i, 1);
                        i--;
                    }
                }
                ctx.globalAlpha = 1; 
            }

            function drawBullet(bullet, speedDirection) {
                 const bulletWidth = 4;
                 const bulletHeight = 25;
                 
                 if (speedDirection === -1) { 
                     const glow = ctx.createRadialGradient(bullet.x + bulletWidth/2, bullet.y, 0, bullet.x + bulletWidth/2, bullet.y, 10);
                     glow.addColorStop(0, 'rgba(255, 100, 100, 0.9)'); 
                     glow.addColorStop(1, 'rgba(255, 0, 51, 0.0)'); 
                     ctx.fillStyle = glow;
                     ctx.fillRect(bullet.x - 5, bullet.y, bulletWidth + 10, -bulletHeight * 2);
                     
                     ctx.fillStyle = bullet.color;
                     ctx.fillRect(bullet.x, bullet.y - bulletHeight, bulletWidth, bulletHeight);
                     
                 } else { 
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, 3, 10);
                 }
            }

            function updateBullets(bullets, speedDirection) {
                const currentBulletSpeed = (speedDirection === -1) ? PLAYER_BULLET_SPEED : ENEMY_BULLET_SPEED;
                
                for (let i = 0; i < bullets.length; i++) {
                    bullets[i].y += currentBulletSpeed * speedDirection; 
                    
                    drawBullet(bullets[i], speedDirection);
                    
                    if (bullets[i].y < 0 || bullets[i].y > canvas.height) {
                        bullets.splice(i, 1);
                        i--;
                    }
                }
            }
            
            function drawBackground() {
                ctx.fillStyle = '#0a0a1a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                for (let i = 0; i < 200; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 2 + 0.5;
                    const opacity = Math.random() * 0.8 + 0.2;
                    ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                    ctx.fillRect(x, y, size, size);
                }
            }
            
            function drawPlayer() {
                if (player.damageCooldown > 0 && Math.floor(player.damageCooldown / 5) % 2 === 0) { return; }
                
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.moveTo(player.x, player.y - player.height / 2); 
                ctx.lineTo(player.x - player.width / 2, player.y + player.height / 2); 
                ctx.lineTo(player.x + player.width / 2, player.y + player.height / 2); 
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#66ccff'; 
                ctx.beginPath();
                ctx.moveTo(player.x, player.y - player.height / 3); 
                ctx.lineTo(player.x - player.width / 4, player.y + player.height / 4); 
                ctx.lineTo(player.x + player.width / 4, player.y + player.height / 4); 
                ctx.closePath();
                ctx.fill();
                
                ctx.fillStyle = 'orange';
                ctx.fillRect(player.x - 15, player.y + player.height / 2, 30, 10);
                ctx.fillStyle = 'red';
                ctx.fillRect(player.x - 10, player.y + player.height / 2 + 10, 20, 15);
            }
            
            function drawEnemy(enemy) {
                ctx.fillStyle = enemy.color;
                
                ctx.beginPath();
                ctx.ellipse(enemy.x, enemy.y, enemy.width / 2, enemy.height / 2, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#cc3300'; 
                ctx.beginPath();
                ctx.ellipse(enemy.x, enemy.y - enemy.height / 4, enemy.width / 3, enemy.height / 4, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'yellow';
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y - enemy.height / 4, enemy.width / 10, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = 'red';
                const healthMultiplier = DIFFICULTY_SETTINGS[currentDifficulty].healthScale;
                const enemyMaxHealth = 1 + level * 10 * healthMultiplier; 
                const healthBarWidth = enemy.width * (enemy.health / enemyMaxHealth);
                ctx.fillRect(enemy.x - enemy.width / 2, enemy.y - enemy.height / 2 - 10, healthBarWidth, 3);
            }

            function drawPowerUp(pu) {
                ctx.strokeStyle = pu.type === 'firePower' ? '#00ccff' : '#ff00ff'; 
                ctx.lineWidth = 3;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';

                ctx.beginPath();
                ctx.moveTo(pu.x, pu.y - powerUpSize / 2);
                ctx.lineTo(pu.x + powerUpSize / 2, pu.y);
                ctx.lineTo(pu.x, pu.y + powerUpSize / 2);
                ctx.lineTo(pu.x - powerUpSize / 2, pu.y);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = ctx.strokeStyle;
                ctx.font = 'bold 20px monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(pu.type === 'firePower' ? player.fireLevel < 5 ? 'F' : 'MAX' : 'D', pu.x, pu.y);
            }

            // --- OYNANIÅž FONKSÄ°YONLARI ---

            function firePlayerBullet() {
                if (player.fireCooldown <= 0) {
                    
                    playSound(playerShootSound); 
                    
                    if (player.fireLevel === 1) {
                         playerBullets.push({ x: player.x - 2, y: player.y - player.height / 2, color: playerBulletColor });
                    } else if (player.fireLevel === 2) {
                        playerBullets.push({ x: player.x - 12, y: player.y - player.height / 2, color: playerBulletColor });
                        playerBullets.push({ x: player.x + 8, y: player.y - player.height / 2, color: playerBulletColor });
                    } else if (player.fireLevel === 3) {
                         playerBullets.push({ x: player.x - 2, y: player.y - player.height / 2, color: playerBulletColor });
                         playerBullets.push({ x: player.x - 17, y: player.y - player.height / 2, color: playerBulletColor });
                         playerBullets.push({ x: player.x + 13, y: player.y - player.height / 2, color: playerBulletColor });
                    } else if (player.fireLevel >= 4) {
                         const spread = player.fireLevel === 4 ? [-15, -5, 5, 15] : [-20, -10, 0, 10, 20];
                         spread.forEach(offset => {
                             playerBullets.push({ x: player.x + offset, y: player.y - player.height / 2, color: playerBulletColor });
                         });
                    }
                    
                    player.fireCooldown = player.fireRate;
                }
            }

            function fireEnemyBullet(enemy) {
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const angle = Math.atan2(dy, dx);

                enemyBullets.push({ 
                    x: enemy.x - 1, 
                    y: enemy.y + enemy.height / 2, 
                    color: enemyBulletColor,
                    vx: ENEMY_BULLET_SPEED * Math.cos(angle) * 0.5, 
                    vy: ENEMY_BULLET_SPEED * Math.sin(angle) * 0.5 + 4 
                });
            }
            
            function updateEnemyBullets() {
                for (let i = 0; i < enemyBullets.length; i++) {
                    enemyBullets[i].x += enemyBullets[i].vx; 
                    enemyBullets[i].y += enemyBullets[i].vy; 
                    
                    drawBullet(enemyBullets[i], 1); 
                    
                    if (enemyBullets[i].y < 0 || enemyBullets[i].y > canvas.height || enemyBullets[i].x < 0 || enemyBullets[i].x > canvas.width) {
                        enemyBullets.splice(i, 1);
                        i--;
                    }
                }
            }

            function createFormation(level, healthMult, fireRateScale, baseFireRate) {
                enemies = [];
                const targetCount = BASE_ENEMY_COUNT + Math.min(30, level * 0.6); 
                const spacing = 60;
                const topY = 100;
                const centerX = canvas.width / 2;

                const enemyMaxHealth = 1 + level * 10 * healthMult; 
                const currentFireRate = baseFireRate * Math.pow(fireRateScale, level - 1); 

                for (let i = 0; i < targetCount; i++) {
                    let size = enemyBaseSize + level * 0.5;
                    
                    const row = Math.floor(i / 2);
                    const isLeft = i % 2 === 0;
                    
                    let x = centerX + (isLeft ? -1 : 1) * row * spacing * 1.5;
                    let y = topY + row * spacing;
                    
                    if (x < size || x > canvas.width - size || y < size || y > canvas.height / 2) {
                        x = (i % 2 === 0) ? 50 + (i * 10) : canvas.width - 50 - (i * 10);
                        y = 50 + (i % 5) * 20; 
                    }

                    enemies.push({ 
                        x, y, 
                        width: size, 
                        height: size * 0.7, 
                        speed: 0, 
                        color: '#ff0000',
                        health: enemyMaxHealth,
                        maxHealth: enemyMaxHealth, 
                        fireCooldown: Math.random() * currentFireRate,
                        fireRate: currentFireRate 
                    });
                }
                enemiesRemainingInLevel = enemies.length;
            }

            function setupLevel() {
                const settings = DIFFICULTY_SETTINGS[currentDifficulty];
                createFormation(level, settings.healthScale, settings.fireRateScale, settings.baseFireRate);
            }

            function showLevelComplete() {
                if (level >= MAX_LEVELS) {
                    levelCompleteText.textContent = `TEBRÄ°KLER! TÃœM ${MAX_LEVELS} BÃ–LÃœMÃœ TAMAMLADINIZ!`;
                    levelCompleteTitle.textContent = "KAHRAMAN!";
                    saveHighScore(currentUserName, score);
                    isLevelComplete = true; 
                    isGamePaused = true;
                    levelCompleteMessage.style.display = 'flex';
                    backgroundMusic.pause();
                    setTimeout(() => {
                        window.location.reload(); 
                    }, 5000);
                    return;
                }

                isLevelComplete = true;
                isGamePaused = true;
                levelCompleteText.textContent = `BÃ¶lÃ¼m ${level + 1}'e HoÅŸ Geldiniz!`;
                levelCompleteMessage.style.display = 'flex';
                
                setTimeout(() => {
                    levelCompleteMessage.style.display = 'none';
                    level++;
                    player.health = 150; 
                    player.fireLevel = Math.min(5, player.fireLevel + 1); 
                    
                    setupLevel();
                    isGamePaused = false;
                    isLevelComplete = false; 
                    saveCurrentLevel(); 
                }, 3000); 
            }

            function updateEnemies() {
                for (let i = 0; i < enemies.length; i++) {
                    if (!enemies[i]) continue; 
                    
                    drawEnemy(enemies[i]);
                    
                    enemies[i].fireCooldown--;
                    if (enemies[i].fireCooldown <= 0) {
                        fireEnemyBullet(enemies[i]);
                        enemies[i].fireCooldown = enemies[i].fireRate + Math.random() * enemies[i].fireRate * 0.5;
                    }
                }
                
                if (enemies.length === 0 && !isLevelComplete) {
                    showLevelComplete();
                }
            }

            function updatePowerUps() {
                for (let i = 0; i < powerUps.length; i++) {
                    const pu = powerUps[i];
                    pu.y += 2; 

                    drawPowerUp(pu);
                    
                    if (pu.y + powerUpSize / 2 > player.y - player.height / 2 && pu.y - powerUpSize / 2 < player.y + player.height / 2 && pu.x + powerUpSize / 2 > player.x - player.width / 2 && pu.x - powerUpSize / 2 < player.x + player.width / 2) {
                        
                        if (pu.type === 'firePower') {
                            if (player.fireLevel < 5) {
                                player.fireLevel++; 
                                player.color = player.fireLevel === 5 ? '#ffff00' : '#00ccff'; 
                            }
                        } 
                        
                        powerUps.splice(i, 1); 
                        i--;
                        continue; 
                    }
                    if (pu.y > canvas.height) {
                        powerUps.splice(i, 1);
                        i--;
                    }
                }
            }


            function checkCollisions() {
                for (let i = 0; i < playerBullets.length; i++) {
                    for (let j = 0; j < enemies.length; j++) {
                        const bullet = playerBullets[i];
                        const enemy = enemies[j];
                        const bulletHitboxY = bullet.y - 25; 
                        
                        if (bullet.x > enemy.x - enemy.width / 2 && bullet.x < enemy.x + enemy.width / 2 && bulletHitboxY > enemy.y - enemy.height / 2 && bulletHitboxY < enemy.y + enemy.height / 2) {
                            
                            enemy.health -= 1; 
                            playerBullets.splice(i, 1); 
                            i--; 
                            
                            if (enemy.health <= 0) {
                                playSound(enemyExplosionSound); 
                                addExplosion(enemy.x, enemy.y, '#ff0000'); 
                                enemies.splice(j, 1); 
                                score += 100 * level; 
                                j--; 

                                if (Math.random() < 0.25) { 
                                     powerUps.push({ 
                                        x: enemy.x, y: enemy.y, 
                                        type: 'firePower' 
                                    });
                                }
                            }
                            return; 
                        }
                    }
                }

                for (let i = 0; i < enemyBullets.length; i++) {
                    const bullet = enemyBullets[i];

                    if (player.damageCooldown <= 0 && bullet.x > player.x - player.width / 2 && bullet.x < player.x + player.width / 2 && bullet.y > player.y - player.height / 2 && bullet.y < player.y + player.height / 2) {
                        
                        player.health -= 10; 
                        player.damageCooldown = 30; 
                        playSound(playerDamageSound); 
                        addExplosion(player.x, player.y, '#00ccff'); 
                        
                        enemyBullets.splice(i, 1);
                        i--; 
                    }
                }
            }
            
            function gameLoop() {
                if (isGamePaused || isLevelComplete || !isPointerLocked) { 
                    gameLoopId = requestAnimationFrame(gameLoop);
                    return;
                }
                
                gameContainer.style.cursor = 'none';

                if (isGameOver) {
                    cancelAnimationFrame(gameLoopId);
                    document.getElementById('finalScore').textContent = score.toLocaleString();
                    gameOverScreen.style.display = 'flex'; 
                    saveCurrentLevel(); 
                    saveHighScore(currentUserName, score);
                    backgroundMusic.pause();
                    return;
                }

                drawBackground(); 
                updateStatus();
                
                if(player.fireCooldown > 0) player.fireCooldown--;
                if(player.damageCooldown > 0) player.damageCooldown--;
                
                if (isMouseDown) {
                    firePlayerBullet();
                }

                drawPlayer();
                updateBullets(playerBullets, -1);
                updateEnemyBullets(); 
                updateEnemies(); 
                updatePowerUps(); 
                drawExplosions(); 

                checkCollisions();

                gameLoopId = requestAnimationFrame(gameLoop);
            }

            function resetGame(difficulty = 'normal') {
                isGameStarted = true;
                currentDifficulty = difficulty;
                score = 0;
                level = 1;
                player.x = canvas.width / 2;
                player.y = canvas.height - 80;
                player.health = 150; 
                player.fireLevel = 1; 
                playerBullets = [];
                enemyBullets = [];
                enemies = [];
                powerUps = [];
                explosions = []; 
                isGameOver = false;
                isGamePaused = true; 
                isLevelComplete = false;
                
                gameOverScreen.style.display = 'none';
                startScreen.style.display = 'none';
                document.getElementById('difficultyBoard').textContent = `Zorluk: ${difficulty.toUpperCase().replace('_', ' ')}`;

                // MÃ¼zik Ã§alma denemesi (kaynak yÃ¼klendiÄŸinde denenir)
                if (backgroundMusic && backgroundMusic.paused && backgroundMusic.src !== "" && backgroundMusic.readyState >= 3) {
                     backgroundMusic.play().catch(e => console.error("MÃ¼zik baÅŸlatÄ±lamadÄ± (TarayÄ±cÄ± kÄ±sÄ±tlamasÄ±). Ä°lk etkileÅŸim gerekli.", e));
                }

                updateStatus(); 
                setupLevel(); 
                
                gameLoop();
            }

            // --- KONTROL MEKANÄ°ZMALARI (AynÄ±) ---
            document.addEventListener('pointerlockchange', () => {
                isPointerLocked = document.pointerLockElement === gameContainer;
                
                if (isPointerLocked) {
                    isGamePaused = false;
                    gameContainer.style.cursor = 'none';
                    // MÃ¼zik Ã§alma denemesi (Fare kilitlendiÄŸinde denenir)
                    if (backgroundMusic && backgroundMusic.paused && backgroundMusic.src !== "" && backgroundMusic.readyState >= 3) {
                         backgroundMusic.play().catch(e => console.error("MÃ¼zik kilitlenme ile baÅŸlatÄ±lamadÄ±.", e));
                    }
                } else {
                    if (!isGameOver) {
                        isGamePaused = true;
                        gameContainer.style.cursor = 'default';
                        backgroundMusic.pause();
                    }
                }
            }, false);

            document.addEventListener('mousemove', (e) => {
                if (!isGameOver && isPointerLocked) {
                    const movementX = e.movementX || e.mozMovementX || e.webkitMovementX || 0;
                    const movementY = e.movementY || e.mozMovementY || e.webkitMovementY || 0;

                    let newX = player.x + movementX;
                    let newY = player.y + movementY;

                    const halfWidth = player.width / 2;
                    const halfHeight = player.height / 2;
                    
                    player.x = Math.min(
                        Math.max(newX, halfWidth), 
                        canvas.width - halfWidth
                    );
                    
                    player.y = Math.min(
                        Math.max(newY, canvas.height * 0.75), 
                        canvas.height - halfHeight
                    );
                }
            });

            gameContainer.addEventListener('mousedown', (e) => {
                if (isGameStarted) {
                     if (!isPointerLocked) {
                        gameContainer.requestPointerLock = gameContainer.requestPointerLock || gameContainer.mozRequestPointerLock;
                        gameContainer.requestPointerLock();
                    } else if (!isGameOver && !isGamePaused) {
                        isMouseDown = true;
                        firePlayerBullet(); 
                    }
                }
            });
            
            gameContainer.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            
            window.addEventListener('keydown', (e) => {
                if (isGameOver && (e.key === 'r' || e.key === 'R')) {
                    e.preventDefault();
                    gameOverScreen.style.display = 'none';
                    startScreen.style.display = 'flex';
                    isGamePaused = true;
                    isGameStarted = false; 
                    if (gameLoopId) cancelAnimationFrame(gameLoopId);
                    loadPlayerData(); 
                }
            });
            
            // --- GÄ°RÄ°Åž EKRANI KONTROLÃœ (AynÄ±) ---
            loginButton.addEventListener('click', () => {
                const name = playerNameInput.value.trim();
                if (name.length >= 2) {
                    saveUserName(name);
                    loginScreen.style.display = 'none';
                    startScreen.style.display = 'flex';
                } else {
                    alert("LÃ¼tfen geÃ§erli bir kullanÄ±cÄ± adÄ± girin (en az 2 karakter).");
                }
            });
            
            playerNameInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                    loginButton.click();
                }
            });

            difficultyOptions.addEventListener('click', (e) => {
                if (e.target.classList.contains('difficulty-button')) {
                    const difficulty = e.target.dataset.difficulty;
                    resetGame(difficulty);
                }
            });

            // BaÅŸlangÄ±Ã§ YÃ¼klemesi
            loadPlayerData();
            if (currentUserName === 'Anonim') {
                loginScreen.style.display = 'flex';
                startScreen.style.display = 'none';
            } else {
                 loginScreen.style.display = 'none';
                 startScreen.style.display = 'flex';
                 currentUserNameDisplay.textContent = currentUserName;
                 savedUserNameDisplay.textContent = currentUserName;
            }
            
            document.body.style.cursor = 'default';

        });
        
    </script>
</body>
</html>